# ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°æ–¹æ¡ˆ

> **åŠŸèƒ½åç§°**: ç®¡ç†å‘˜ç”¨æˆ·å¢åˆ æ”¹æŸ¥ï¼ˆUser CRUD for Adminï¼‰
> **ç‰ˆæœ¬**: 1.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-02
> **é¡¹ç›®**: SystemX - Fast Accent Translate Web

---

## ğŸ“‹ ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#1-åŠŸèƒ½æ¦‚è¿°)
2. [åœºæ™¯æè¿°](#2-åœºæ™¯æè¿°)
3. [æŠ€æœ¯æ¶æ„](#3-æŠ€æœ¯æ¶æ„)
4. [æ¥å£è®¾è®¡](#4-æ¥å£è®¾è®¡)
5. [åç«¯å®ç°](#5-åç«¯å®ç°)
6. [å‰ç«¯å®ç°](#6-å‰ç«¯å®ç°)
7. [å®‰å…¨è€ƒè™‘](#7-å®‰å…¨è€ƒè™‘)
8. [æµ‹è¯•æ–¹æ¡ˆ](#8-æµ‹è¯•æ–¹æ¡ˆ)
9. [éƒ¨ç½²æŒ‡å—](#9-éƒ¨ç½²æŒ‡å—)

---

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 åŠŸèƒ½å®šä¹‰

å®ç°ç®¡ç†å‘˜å¯¹ç³»ç»Ÿç”¨æˆ·çš„å®Œæ•´ç®¡ç†èƒ½åŠ›ï¼ŒåŒ…æ‹¬ï¼š
- **æŸ¥è¯¢ï¼ˆReadï¼‰**: æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ã€æœç´¢ç”¨æˆ·ã€æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
- **åˆ›å»ºï¼ˆCreateï¼‰**: æ·»åŠ æ–°ç”¨æˆ·ï¼ˆæ™®é€šç”¨æˆ·æˆ–ç®¡ç†å‘˜ï¼‰
- **æ›´æ–°ï¼ˆUpdateï¼‰**: ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€é‡ç½®å¯†ç ã€æ›´æ”¹è§’è‰²
- **åˆ é™¤ï¼ˆDeleteï¼‰**: åˆ é™¤ç”¨æˆ·è´¦æˆ·ï¼ˆè½¯åˆ é™¤æˆ–ç¡¬åˆ é™¤ï¼‰

### 1.2 æ ¸å¿ƒç›®æ ‡

1. **æƒé™ç®¡ç†**: ç¡®ä¿åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œç”¨æˆ·ç®¡ç†æ“ä½œ
2. **æ•°æ®å®Œæ•´æ€§**: ä¿è¯ç”¨æˆ·æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§
3. **å®¡è®¡è¿½è¸ª**: è®°å½•æ‰€æœ‰ç®¡ç†æ“ä½œï¼Œä¾¿äºå®¡è®¡
4. **ç”¨æˆ·ä½“éªŒ**: æä¾›ç›´è§‚çš„ç®¡ç†ç•Œé¢å’Œå‹å¥½çš„äº¤äº’

### 1.3 æŠ€æœ¯ç‰¹ç‚¹

- **RESTful API**: éµå¾ª REST è®¾è®¡åŸåˆ™
- **JWT è®¤è¯**: åŸºäºä»¤ç‰Œçš„èº«ä»½éªŒè¯
- **RBAC æƒé™æ§åˆ¶**: åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- **åˆ†é¡µæŸ¥è¯¢**: æ”¯æŒå¤§é‡ç”¨æˆ·æ•°æ®çš„é«˜æ•ˆå±•ç¤º
- **æœç´¢è¿‡æ»¤**: æ”¯æŒæŒ‰ç”¨æˆ·åã€é‚®ç®±ã€è§’è‰²æœç´¢

---

## 2. åœºæ™¯æè¿°

### 2.1 ç”¨æˆ·è§’è‰²å®šä¹‰

#### æ™®é€šç”¨æˆ·ï¼ˆUserï¼‰
- **è§’è‰²æ ‡è¯†**: `role = "user"`
- **æƒé™**:
  - âœ… æ³¨å†Œè´¦æˆ·
  - âœ… ç™»å½•ç³»ç»Ÿ
  - âœ… ä½¿ç”¨è¯­éŸ³è¯†åˆ«å’Œ TTS åŠŸèƒ½
  - âœ… ç®¡ç†è‡ªå·±çš„ä¼šè¯å’Œå¯¹è¯
  - âœ… ä¿®æ”¹è‡ªå·±çš„å¯†ç 
  - âŒ è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½

#### ç®¡ç†å‘˜ï¼ˆAdminï¼‰
- **è§’è‰²æ ‡è¯†**: `role = "admin"`
- **æƒé™**:
  - âœ… æ‰€æœ‰æ™®é€šç”¨æˆ·æƒé™
  - âœ… æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
  - âœ… æœç´¢å’Œè¿‡æ»¤ç”¨æˆ·
  - âœ… æŸ¥çœ‹ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
  - âœ… åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆåŒ…æ‹¬ç®¡ç†å‘˜ï¼‰
  - âœ… ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
  - âœ… é‡ç½®ç”¨æˆ·å¯†ç 
  - âœ… æ›´æ”¹ç”¨æˆ·è§’è‰²
  - âœ… åˆ é™¤ç”¨æˆ·
  - âœ… æŸ¥çœ‹æ“ä½œæ—¥å¿—

### 2.2 å…¸å‹ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1: ç®¡ç†å‘˜ç™»å½•ç³»ç»Ÿ
```
ç”¨æˆ·æ“ä½œ:
1. ç®¡ç†å‘˜è®¿é—®ç™»å½•é¡µé¢
2. è¾“å…¥ç®¡ç†å‘˜è´¦å·å’Œå¯†ç 
3. ç³»ç»ŸéªŒè¯èº«ä»½å’Œè§’è‰²
4. ç™»å½•æˆåŠŸåï¼Œæ˜¾ç¤ºç®¡ç†å‘˜ä¸“å±èœå•

ç³»ç»Ÿå“åº”:
- éªŒè¯ç”¨æˆ·åå’Œå¯†ç 
- æ£€æŸ¥ user.role == "admin"
- ç”Ÿæˆ JWT tokenï¼ˆåŒ…å«è§’è‰²ä¿¡æ¯ï¼‰
- è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
- å‰ç«¯æ ¹æ®è§’è‰²æ˜¾ç¤ºç®¡ç†èœå•
```

#### åœºæ™¯ 2: æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
```
ç”¨æˆ·æ“ä½œ:
1. ç®¡ç†å‘˜ç‚¹å‡»"ç”¨æˆ·ç®¡ç†"èœå•
2. è¿›å…¥ç”¨æˆ·åˆ—è¡¨é¡µé¢
3. ç³»ç»Ÿæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- æŸ¥è¯¢ç”¨æˆ·è¡¨ï¼Œæ”¯æŒåˆ†é¡µ
- è¿”å›ç”¨æˆ·åˆ—è¡¨ï¼ˆä¸åŒ…å«å¯†ç ï¼‰
- æ˜¾ç¤ºï¼šç”¨æˆ·åã€é‚®ç®±ã€è§’è‰²ã€åˆ›å»ºæ—¶é—´ã€çŠ¶æ€

å‰ç«¯å±•ç¤º:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç®¡ç†                    [+ æ·»åŠ ç”¨æˆ·] [ğŸ” æœç´¢] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·å      é‚®ç®±                è§’è‰²   åˆ›å»ºæ—¶é—´      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ admin      admin@example.com   ç®¡ç†å‘˜ 2025-11-01   â”‚
â”‚ rachel     rachel@outlook.com  ç”¨æˆ·   2025-11-02   â”‚
â”‚ john       john@example.com    ç”¨æˆ·   2025-11-02   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           [ä¸Šä¸€é¡µ]  1 / 5  [ä¸‹ä¸€é¡µ]
```

#### åœºæ™¯ 3: æœç´¢ç”¨æˆ·
```
ç”¨æˆ·æ“ä½œ:
1. åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯ï¼ˆå¦‚ "rachel"ï¼‰
2. ç‚¹å‡»æœç´¢æˆ–æŒ‰å›è½¦
3. ç³»ç»Ÿæ˜¾ç¤ºåŒ¹é…çš„ç”¨æˆ·

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- åœ¨ username å’Œ email å­—æ®µä¸­æœç´¢
- æ”¯æŒæ¨¡ç³ŠåŒ¹é…
- è¿”å›åŒ¹é…ç»“æœ

æŸ¥è¯¢ç¤ºä¾‹:
WHERE username LIKE '%rachel%' OR email LIKE '%rachel%'
```

#### åœºæ™¯ 4: æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
```
ç”¨æˆ·æ“ä½œ:
1. ç‚¹å‡»ç”¨æˆ·åˆ—è¡¨ä¸­çš„æŸä¸ªç”¨æˆ·
2. æ‰“å¼€ç”¨æˆ·è¯¦æƒ…å¯¹è¯æ¡†æˆ–é¡µé¢

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- æŸ¥è¯¢ç”¨æˆ·å®Œæ•´ä¿¡æ¯
- æŸ¥è¯¢ç”¨æˆ·çš„ä¼šè¯ç»Ÿè®¡æ•°æ®

æ˜¾ç¤ºå†…å®¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¯¦æƒ…                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID: 550e8400-e29b-41d4-...   â”‚
â”‚ ç”¨æˆ·å: rachel               â”‚
â”‚ é‚®ç®±: rachel@outlook.com     â”‚
â”‚ è§’è‰²: ç”¨æˆ·                   â”‚
â”‚ åˆ›å»ºæ—¶é—´: 2025-11-02 10:30  â”‚
â”‚ æœ€åç™»å½•: 2025-11-02 18:45  â”‚
â”‚                              â”‚
â”‚ ç»Ÿè®¡æ•°æ®:                    â”‚
â”‚ - æ€»ä¼šè¯æ•°: 25              â”‚
â”‚ - æ€»å¯¹è¯æ•°: 156             â”‚
â”‚ - è´¦æˆ·çŠ¶æ€: æ­£å¸¸            â”‚
â”‚                              â”‚
â”‚ [ç¼–è¾‘] [é‡ç½®å¯†ç ] [åˆ é™¤]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### åœºæ™¯ 5: åˆ›å»ºæ–°ç”¨æˆ·
```
ç”¨æˆ·æ“ä½œ:
1. ç‚¹å‡»"æ·»åŠ ç”¨æˆ·"æŒ‰é’®
2. å¡«å†™æ–°ç”¨æˆ·ä¿¡æ¯è¡¨å•
3. æäº¤åˆ›å»ºè¯·æ±‚

è¡¨å•å†…å®¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ æ–°ç”¨æˆ·                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·å: [____________]       â”‚
â”‚ é‚®ç®±:   [____________]       â”‚
â”‚ å¯†ç :   [____________]       â”‚
â”‚ è§’è‰²:   [ç”¨æˆ· â–¼] æˆ– [ç®¡ç†å‘˜] â”‚
â”‚                              â”‚
â”‚ [å–æ¶ˆ]          [åˆ›å»ºç”¨æˆ·]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
- éªŒè¯é‚®ç®±æ ¼å¼å’Œå”¯ä¸€æ€§
- éªŒè¯å¯†ç å¼ºåº¦
- å“ˆå¸Œå¯†ç 
- åˆ›å»ºç”¨æˆ·è®°å½•
- è¿”å›æˆåŠŸä¿¡æ¯

æˆåŠŸæ¶ˆæ¯:
"âœ… ç”¨æˆ· 'newuser' åˆ›å»ºæˆåŠŸï¼"
```

#### åœºæ™¯ 6: ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
```
ç”¨æˆ·æ“ä½œ:
1. åœ¨ç”¨æˆ·åˆ—è¡¨æˆ–è¯¦æƒ…é¡µç‚¹å‡»"ç¼–è¾‘"
2. ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
3. ä¿å­˜æ›´æ”¹

å¯ç¼–è¾‘å­—æ®µ:
- ç”¨æˆ·åï¼ˆéœ€éªŒè¯å”¯ä¸€æ€§ï¼‰
- é‚®ç®±
- è§’è‰²ï¼ˆuser/adminï¼‰
- è´¦æˆ·çŠ¶æ€ï¼ˆæ¿€æ´»/ç¦ç”¨ï¼‰

ä¸å¯ç¼–è¾‘:
- ç”¨æˆ· ID
- åˆ›å»ºæ—¶é—´
- å¯†ç ï¼ˆéœ€å•ç‹¬é‡ç½®ï¼‰

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- éªŒè¯æ–°æ•°æ®çš„æœ‰æ•ˆæ€§
- æ›´æ–°ç”¨æˆ·è®°å½•
- è®°å½•æ“ä½œæ—¥å¿—
```

#### åœºæ™¯ 7: é‡ç½®ç”¨æˆ·å¯†ç 
```
ç”¨æˆ·æ“ä½œ:
1. åœ¨ç”¨æˆ·è¯¦æƒ…é¡µç‚¹å‡»"é‡ç½®å¯†ç "
2. è¾“å…¥æ–°å¯†ç 
3. ç¡®è®¤é‡ç½®

è¡¨å•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡ç½®ç”¨æˆ·å¯†ç                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·: rachel                 â”‚
â”‚                              â”‚
â”‚ æ–°å¯†ç :     [____________]   â”‚
â”‚ ç¡®è®¤å¯†ç :   [____________]   â”‚
â”‚                              â”‚
â”‚ [å–æ¶ˆ]          [é‡ç½®å¯†ç ]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- éªŒè¯æ–°å¯†ç å¼ºåº¦
- å“ˆå¸Œæ–°å¯†ç 
- æ›´æ–°ç”¨æˆ·å¯†ç 
- å¯é€‰ï¼šå‘é€é‚®ä»¶é€šçŸ¥ç”¨æˆ·
- å¯é€‰ï¼šå¼ºåˆ¶ç”¨æˆ·ä¸‹æ¬¡ç™»å½•ä¿®æ”¹å¯†ç 

å®‰å…¨æç¤º:
âš ï¸ é‡ç½®å¯†ç åï¼Œç”¨æˆ·å½“å‰çš„æ‰€æœ‰ä¼šè¯å°†å¤±æ•ˆ
```

#### åœºæ™¯ 8: åˆ é™¤ç”¨æˆ·
```
ç”¨æˆ·æ“ä½œ:
1. åœ¨ç”¨æˆ·åˆ—è¡¨ç‚¹å‡»åˆ é™¤æŒ‰é’®
2. ç¡®è®¤åˆ é™¤æ“ä½œ

ç¡®è®¤å¯¹è¯æ¡†:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ ç¡®è®¤åˆ é™¤ç”¨æˆ·              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‚¨ç¡®å®šè¦åˆ é™¤ç”¨æˆ· 'rachel' å—ï¼Ÿâ”‚
â”‚                              â”‚
â”‚ æ­¤æ“ä½œå°†ï¼š                   â”‚
â”‚ â€¢ åˆ é™¤ç”¨æˆ·è´¦æˆ·               â”‚
â”‚ â€¢ åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯         â”‚
â”‚ â€¢ åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯è®°å½•     â”‚
â”‚                              â”‚
â”‚ âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼          â”‚
â”‚                              â”‚
â”‚ [å–æ¶ˆ]            [ç¡®è®¤åˆ é™¤] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿå“åº”:
- éªŒè¯ç®¡ç†å‘˜èº«ä»½
- æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªç®¡ç†å‘˜ï¼ˆç¦æ­¢åˆ é™¤ï¼‰
- åˆ é™¤å…³è”æ•°æ®ï¼ˆä¼šè¯ã€å¯¹è¯ï¼‰
- åˆ é™¤ç”¨æˆ·è®°å½•
- è®°å½•åˆ é™¤æ“ä½œåˆ°å®¡è®¡æ—¥å¿—

ä¿æŠ¤æœºåˆ¶:
âŒ ä¸èƒ½åˆ é™¤è‡ªå·±
âŒ ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
âœ… å¯ä»¥å®ç°è½¯åˆ é™¤ï¼ˆæ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œä¸çœŸæ­£åˆ é™¤ï¼‰
```

#### åœºæ™¯ 9: æ‰¹é‡æ“ä½œ
```
ç”¨æˆ·æ“ä½œ:
1. å‹¾é€‰å¤šä¸ªç”¨æˆ·
2. é€‰æ‹©æ‰¹é‡æ“ä½œï¼ˆåˆ é™¤ã€æ›´æ”¹è§’è‰²ç­‰ï¼‰
3. ç¡®è®¤æ‰§è¡Œ

ç•Œé¢ç¤ºä¾‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [âœ“] å·²é€‰æ‹© 3 ä¸ªç”¨æˆ·   [æ‰¹é‡åˆ é™¤] [æ‰¹é‡æ›´æ”¹è§’è‰²]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [âœ“] john      john@example.com    ç”¨æˆ·             â”‚
â”‚ [âœ“] mary      mary@example.com    ç”¨æˆ·             â”‚
â”‚ [âœ“] tom       tom@example.com     ç”¨æˆ·             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç³»ç»Ÿå“åº”:
- é€ä¸ªéªŒè¯æ“ä½œæƒé™
- äº‹åŠ¡å¤„ç†ï¼ˆå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»šï¼‰
- è¿”å›æ‰¹é‡æ“ä½œç»“æœ
```

---

## 3. æŠ€æœ¯æ¶æ„

### 3.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å‰ç«¯ (React)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç”¨æˆ·åˆ—è¡¨é¡µé¢ â”‚  â”‚ ç”¨æˆ·è¯¦æƒ…é¡µé¢ â”‚  â”‚ ç¼–è¾‘ç”¨æˆ·é¡µé¢ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚   API Client   â”‚                    â”‚
â”‚                    â”‚  (api/admin.js)â”‚                    â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS + JWT
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯ (FastAPI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          API è·¯ç”± (admin.py)                       â”‚  â”‚
â”‚  â”‚  GET    /admin/users          - è·å–ç”¨æˆ·åˆ—è¡¨      â”‚  â”‚
â”‚  â”‚  GET    /admin/users/:id      - è·å–ç”¨æˆ·è¯¦æƒ…      â”‚  â”‚
â”‚  â”‚  POST   /admin/users          - åˆ›å»ºæ–°ç”¨æˆ·        â”‚  â”‚
â”‚  â”‚  PUT    /admin/users/:id      - æ›´æ–°ç”¨æˆ·ä¿¡æ¯      â”‚  â”‚
â”‚  â”‚  DELETE /admin/users/:id      - åˆ é™¤ç”¨æˆ·          â”‚  â”‚
â”‚  â”‚  POST   /admin/users/:id/reset-password           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         æƒé™ä¸­é—´ä»¶ (deps.py)                       â”‚  â”‚
â”‚  â”‚  â€¢ get_current_user()     - éªŒè¯ JWT             â”‚  â”‚
â”‚  â”‚  â€¢ require_admin()        - éªŒè¯ç®¡ç†å‘˜æƒé™        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         ä¸šåŠ¡é€»è¾‘å±‚                                  â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·æŸ¥è¯¢ä¸è¿‡æ»¤                                  â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åˆ›å»ºä¸éªŒè¯                                  â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·æ›´æ–°ä¸æƒé™æ£€æŸ¥                              â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·åˆ é™¤ä¸çº§è”å¤„ç†                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         æ•°æ®è®¿é—®å±‚ (Tortoise ORM)                  â”‚  â”‚
â”‚  â”‚  â€¢ User.filter()                                   â”‚  â”‚
â”‚  â”‚  â€¢ User.get()                                      â”‚  â”‚
â”‚  â”‚  â€¢ User.create()                                   â”‚  â”‚
â”‚  â”‚  â€¢ User.update()                                   â”‚  â”‚
â”‚  â”‚  â€¢ User.delete()                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ•°æ®åº“ (SQLite/PostgreSQL)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  users è¡¨                                          â”‚  â”‚
â”‚  â”‚  - id (UUID)                                       â”‚  â”‚
â”‚  â”‚  - username (VARCHAR, UNIQUE)                      â”‚  â”‚
â”‚  â”‚  - email (VARCHAR)                                 â”‚  â”‚
â”‚  â”‚  - password_hash (VARCHAR)                         â”‚  â”‚
â”‚  â”‚  - role (VARCHAR: 'user' | 'admin')               â”‚  â”‚
â”‚  â”‚  - created_at (TIMESTAMP)                          â”‚  â”‚
â”‚  â”‚  - updated_at (TIMESTAMP)                          â”‚  â”‚
â”‚  â”‚  - last_login (TIMESTAMP)                          â”‚  â”‚
â”‚  â”‚  - is_active (BOOLEAN)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•°æ®æµç¨‹

#### æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨æµç¨‹
```
1. å‰ç«¯å‘èµ·è¯·æ±‚
   GET /api/v1/admin/users?page=1&limit=20&search=rachel
   Headers: Authorization: Bearer <jwt_token>

2. åç«¯æ¥æ”¶è¯·æ±‚
   â†“
3. JWT ä¸­é—´ä»¶éªŒè¯ token
   â†“
4. ç®¡ç†å‘˜æƒé™ä¸­é—´ä»¶éªŒè¯ role == 'admin'
   â†“
5. è§£ææŸ¥è¯¢å‚æ•°ï¼ˆåˆ†é¡µã€æœç´¢ï¼‰
   â†“
6. æ„å»ºæ•°æ®åº“æŸ¥è¯¢
   SELECT * FROM users
   WHERE username LIKE '%rachel%' OR email LIKE '%rachel%'
   ORDER BY created_at DESC
   LIMIT 20 OFFSET 0
   â†“
7. æ‰§è¡ŒæŸ¥è¯¢ï¼Œè·å–ç»“æœ
   â†“
8. åºåˆ—åŒ–æ•°æ®ï¼ˆç§»é™¤æ•æ„Ÿå­—æ®µ password_hashï¼‰
   â†“
9. è¿”å› JSON å“åº”
   {
     "success": true,
     "data": {
       "users": [...],
       "total": 100,
       "page": 1,
       "pageSize": 20
     }
   }
   â†“
10. å‰ç«¯æ¥æ”¶å¹¶æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
```

#### åˆ›å»ºç”¨æˆ·æµç¨‹
```
1. å‰ç«¯è¡¨å•æäº¤
   POST /api/v1/admin/users
   Body: {
     "username": "newuser",
     "email": "new@example.com",
     "password": "SecurePass123",
     "role": "user"
   }

2. éªŒè¯ç®¡ç†å‘˜æƒé™
   â†“
3. éªŒè¯è¾“å…¥æ•°æ®
   - ç”¨æˆ·åæ ¼å¼ï¼ˆ3-32å­—ç¬¦ï¼Œå­—æ¯æ•°å­—ä¸‹åˆ’çº¿ï¼‰
   - é‚®ç®±æ ¼å¼
   - å¯†ç å¼ºåº¦ï¼ˆè‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼‰
   - è§’è‰²æœ‰æ•ˆæ€§ï¼ˆuser æˆ– adminï¼‰
   â†“
4. æ£€æŸ¥å”¯ä¸€æ€§
   - æŸ¥è¯¢ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
   - æŸ¥è¯¢é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
   â†“
5. å“ˆå¸Œå¯†ç 
   password_hash = argon2.hash(password)
   â†“
6. åˆ›å»ºç”¨æˆ·è®°å½•
   INSERT INTO users (...) VALUES (...)
   â†“
7. è¿”å›åˆ›å»ºç»“æœï¼ˆä¸åŒ…å«å¯†ç ï¼‰
   {
     "success": true,
     "data": {
       "id": "uuid",
       "username": "newuser",
       "email": "new@example.com",
       "role": "user",
       "created_at": "2025-11-02T..."
     }
   }
```

### 3.3 æƒé™æ§åˆ¶æœºåˆ¶

#### JWT Token ç»“æ„
```json
{
  "sub": "user-uuid",           // ç”¨æˆ· ID
  "username": "rachel",         // ç”¨æˆ·å
  "role": "admin",              // è§’è‰²
  "iat": 1699000000,            // ç­¾å‘æ—¶é—´
  "exp": 1699003600             // è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶åï¼‰
}
```

#### æƒé™éªŒè¯æµç¨‹
```python
# 1. æå– token
token = request.headers.get("Authorization").split("Bearer ")[1]

# 2. è§£ç  token
payload = jwt.decode(token, JWT_SECRET, algorithms=["HS256"])

# 3. è·å–ç”¨æˆ·
user_id = payload.get("sub")
user = await User.get(id=user_id)

# 4. éªŒè¯è§’è‰²
if user.role != "admin":
    raise HTTPException(status_code=403, detail="éœ€è¦ç®¡ç†å‘˜æƒé™")

# 5. ç»§ç»­å¤„ç†è¯·æ±‚
...
```

---

## 4. æ¥å£è®¾è®¡

### 4.1 è·å–ç”¨æˆ·åˆ—è¡¨

**æ¥å£**: `GET /api/v1/admin/users`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|------|------|--------|------|
| page | int | å¦ | é¡µç ï¼ˆä»1å¼€å§‹ï¼‰ | 1 | 1 |
| limit | int | å¦ | æ¯é¡µæ•°é‡ | 20 | 20 |
| search | string | å¦ | æœç´¢å…³é”®è¯ï¼ˆç”¨æˆ·åæˆ–é‚®ç®±ï¼‰ | - | "rachel" |
| role | string | å¦ | è§’è‰²è¿‡æ»¤ | - | "admin" |
| sort_by | string | å¦ | æ’åºå­—æ®µ | "created_at" | "username" |
| sort_order | string | å¦ | æ’åºæ–¹å‘ | "desc" | "asc" |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X GET "http://localhost:8000/api/v1/admin/users?page=1&limit=20&search=rachel" \
  -H "Authorization: Bearer eyJhbGci..."
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "username": "rachel",
        "email": "rachel@outlook.com",
        "role": "user",
        "is_active": true,
        "created_at": "2025-11-02T10:30:00Z",
        "last_login": "2025-11-02T18:45:00Z"
      },
      {
        "id": "660e8400-e29b-41d4-a716-446655440001",
        "username": "admin",
        "email": "admin@example.com",
        "role": "admin",
        "is_active": true,
        "created_at": "2025-11-01T08:00:00Z",
        "last_login": "2025-11-02T19:00:00Z"
      }
    ],
    "pagination": {
      "total": 156,
      "page": 1,
      "pageSize": 20,
      "totalPages": 8
    }
  }
}
```

**å“åº”å¤±è´¥ (403)**:
```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "éœ€è¦ç®¡ç†å‘˜æƒé™"
  }
}
```

---

### 4.2 è·å–ç”¨æˆ·è¯¦æƒ…

**æ¥å£**: `GET /api/v1/admin/users/{user_id}`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | string (UUID) | ç”¨æˆ·ID |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X GET "http://localhost:8000/api/v1/admin/users/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer eyJhbGci..."
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "rachel",
    "email": "rachel@outlook.com",
    "role": "user",
    "is_active": true,
    "created_at": "2025-11-02T10:30:00Z",
    "updated_at": "2025-11-02T15:20:00Z",
    "last_login": "2025-11-02T18:45:00Z",
    "statistics": {
      "total_conversations": 25,
      "total_transcripts": 156,
      "last_activity": "2025-11-02T18:45:00Z"
    }
  }
}
```

**å“åº”å¤±è´¥ (404)**:
```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "ç”¨æˆ·ä¸å­˜åœ¨"
  }
}
```

---

### 4.3 åˆ›å»ºç”¨æˆ·

**æ¥å£**: `POST /api/v1/admin/users`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è¯·æ±‚ä½“**:
```json
{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "SecurePass123",
  "role": "user"
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | éªŒè¯è§„åˆ™ |
|------|------|------|------|----------|
| username | string | æ˜¯ | ç”¨æˆ·å | 3-32å­—ç¬¦ï¼Œåªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ |
| email | string | æ˜¯ | é‚®ç®± | æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼ |
| password | string | æ˜¯ | å¯†ç  | è‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­— |
| role | string | å¦ | è§’è‰² | "user" æˆ– "admin"ï¼Œé»˜è®¤ "user" |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/v1/admin/users" \
  -H "Authorization: Bearer eyJhbGci..." \
  -H "Content-Type: application/json" \
  -d '{
    "username": "newuser",
    "email": "newuser@example.com",
    "password": "SecurePass123",
    "role": "user"
  }'
```

**å“åº”æˆåŠŸ (201)**:
```json
{
  "success": true,
  "data": {
    "id": "770e8400-e29b-41d4-a716-446655440002",
    "username": "newuser",
    "email": "newuser@example.com",
    "role": "user",
    "is_active": true,
    "created_at": "2025-11-02T19:30:00Z"
  },
  "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ"
}
```

**å“åº”å¤±è´¥ (400)**:
```json
{
  "success": false,
  "error": {
    "code": "USERNAME_EXISTS",
    "message": "ç”¨æˆ·åå·²å­˜åœ¨",
    "field": "username"
  }
}
```

**å“åº”å¤±è´¥ (400) - å¯†ç å¼ºåº¦ä¸è¶³**:
```json
{
  "success": false,
  "error": {
    "code": "WEAK_PASSWORD",
    "message": "å¯†ç å¿…é¡»è‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—",
    "field": "password"
  }
}
```

---

### 4.4 æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**æ¥å£**: `PUT /api/v1/admin/users/{user_id}`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | string (UUID) | ç”¨æˆ·ID |

**è¯·æ±‚ä½“**:
```json
{
  "username": "rachel_updated",
  "email": "rachel_new@outlook.com",
  "role": "admin",
  "is_active": true
}
```

**å­—æ®µè¯´æ˜**:
| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| username | string | å¦ | ç”¨æˆ·å |
| email | string | å¦ | é‚®ç®± |
| role | string | å¦ | è§’è‰² |
| is_active | boolean | å¦ | è´¦æˆ·çŠ¶æ€ |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X PUT "http://localhost:8000/api/v1/admin/users/550e8400-e29b-41d4-a716-446655440000" \
  -H "Authorization: Bearer eyJhbGci..." \
  -H "Content-Type: application/json" \
  -d '{
    "role": "admin"
  }'
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "rachel",
    "email": "rachel@outlook.com",
    "role": "admin",
    "is_active": true,
    "updated_at": "2025-11-02T19:35:00Z"
  },
  "message": "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"
}
```

**å“åº”å¤±è´¥ (409)**:
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_DEMOTE_LAST_ADMIN",
    "message": "ä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜çš„ç®¡ç†å‘˜æƒé™"
  }
}
```

---

### 4.5 é‡ç½®ç”¨æˆ·å¯†ç 

**æ¥å£**: `POST /api/v1/admin/users/{user_id}/reset-password`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | string (UUID) | ç”¨æˆ·ID |

**è¯·æ±‚ä½“**:
```json
{
  "new_password": "NewSecurePass456"
}
```

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST "http://localhost:8000/api/v1/admin/users/550e8400-e29b-41d4-a716-446655440000/reset-password" \
  -H "Authorization: Bearer eyJhbGci..." \
  -H "Content-Type: application/json" \
  -d '{
    "new_password": "NewSecurePass456"
  }'
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "å¯†ç é‡ç½®æˆåŠŸ",
  "data": {
    "user_id": "550e8400-e29b-41d4-a716-446655440000",
    "username": "rachel",
    "password_changed_at": "2025-11-02T19:40:00Z"
  }
}
```

**å“åº”å¤±è´¥ (400)**:
```json
{
  "success": false,
  "error": {
    "code": "WEAK_PASSWORD",
    "message": "å¯†ç å¿…é¡»è‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—"
  }
}
```

---

### 4.6 åˆ é™¤ç”¨æˆ·

**æ¥å£**: `DELETE /api/v1/admin/users/{user_id}`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è·¯å¾„å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| user_id | string (UUID) | ç”¨æˆ·ID |

**æŸ¥è¯¢å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|------|--------|
| cascade | boolean | å¦ | æ˜¯å¦çº§è”åˆ é™¤å…³è”æ•°æ® | true |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X DELETE "http://localhost:8000/api/v1/admin/users/550e8400-e29b-41d4-a716-446655440000?cascade=true" \
  -H "Authorization: Bearer eyJhbGci..."
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "ç”¨æˆ·åˆ é™¤æˆåŠŸ",
  "data": {
    "deleted_user_id": "550e8400-e29b-41d4-a716-446655440000",
    "deleted_conversations": 25,
    "deleted_transcripts": 156,
    "deleted_at": "2025-11-02T19:45:00Z"
  }
}
```

**å“åº”å¤±è´¥ (403)**:
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_DELETE_SELF",
    "message": "ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·"
  }
}
```

**å“åº”å¤±è´¥ (409)**:
```json
{
  "success": false,
  "error": {
    "code": "CANNOT_DELETE_LAST_ADMIN",
    "message": "ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·"
  }
}
```

---

### 4.7 æ‰¹é‡åˆ é™¤ç”¨æˆ·

**æ¥å£**: `POST /api/v1/admin/users/batch-delete`

**æƒé™**: éœ€è¦ç®¡ç†å‘˜æƒé™

**è¯·æ±‚ä½“**:
```json
{
  "user_ids": [
    "550e8400-e29b-41d4-a716-446655440000",
    "660e8400-e29b-41d4-a716-446655440001"
  ],
  "cascade": true
}
```

**å“åº”æˆåŠŸ (200)**:
```json
{
  "success": true,
  "message": "æ‰¹é‡åˆ é™¤å®Œæˆ",
  "data": {
    "total": 2,
    "succeeded": 1,
    "failed": 1,
    "results": [
      {
        "user_id": "550e8400-e29b-41d4-a716-446655440000",
        "status": "success",
        "message": "åˆ é™¤æˆåŠŸ"
      },
      {
        "user_id": "660e8400-e29b-41d4-a716-446655440001",
        "status": "failed",
        "message": "ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜è´¦æˆ·"
      }
    ]
  }
}
```

---

## 5. åç«¯å®ç°

### 5.1 ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/v1/
â”‚   â”‚   â”œâ”€â”€ deps.py                 # ä¾èµ–é¡¹ï¼ˆæƒé™éªŒè¯ï¼‰
â”‚   â”‚   â””â”€â”€ routers/
â”‚   â”‚       â””â”€â”€ admin.py            # ç®¡ç†å‘˜è·¯ç”±ï¼ˆç”¨æˆ·ç®¡ç†ï¼‰
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â””â”€â”€ security.py             # å®‰å…¨ç›¸å…³ï¼ˆå¯†ç å“ˆå¸Œã€JWTï¼‰
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ user.py                 # ç”¨æˆ·æ¨¡å‹ï¼ˆéœ€è¦æ‰©å±•ï¼‰
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ admin.py                # Pydantic æ¨¡å¼ï¼ˆæ–°å»ºï¼‰
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ user_service.py         # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘ï¼ˆæ–°å»ºï¼‰
```

### 5.2 æ‰©å±•ç”¨æˆ·æ¨¡å‹

**æ–‡ä»¶**: `backend/app/models/user.py`

**éœ€è¦æ·»åŠ çš„å­—æ®µ**:
```python
class User(models.Model):
    id = fields.UUIDField(pk=True, default=uuid.uuid4)
    username = fields.CharField(max_length=256, unique=True, index=True)
    email = fields.CharField(max_length=256, null=True, unique=True)
    password_hash = fields.CharField(max_length=255)
    role = fields.CharField(max_length=16, default="user")
    is_active = fields.BooleanField(default=True)  # æ–°å¢ï¼šè´¦æˆ·çŠ¶æ€
    created_at = fields.DatetimeField(auto_now_add=True)
    updated_at = fields.DatetimeField(auto_now=True)  # æ–°å¢ï¼šæ›´æ–°æ—¶é—´
    last_login = fields.DatetimeField(null=True)      # æ–°å¢ï¼šæœ€åç™»å½•æ—¶é—´

    class Meta:
        table = "users"
```

### 5.3 åˆ›å»º Pydantic æ¨¡å¼

**æ–‡ä»¶**: `backend/app/schemas/admin.py`ï¼ˆæ–°å»ºï¼‰

```python
from pydantic import BaseModel, EmailStr, Field, validator
from datetime import datetime
from typing import Optional
import re

# ============ ç”¨æˆ·åˆ—è¡¨ç›¸å…³ ============

class UserListQuery(BaseModel):
    """ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢å‚æ•°"""
    page: int = Field(default=1, ge=1, description="é¡µç ")
    limit: int = Field(default=20, ge=1, le=100, description="æ¯é¡µæ•°é‡")
    search: Optional[str] = Field(default=None, description="æœç´¢å…³é”®è¯")
    role: Optional[str] = Field(default=None, description="è§’è‰²è¿‡æ»¤")
    sort_by: str = Field(default="created_at", description="æ’åºå­—æ®µ")
    sort_order: str = Field(default="desc", description="æ’åºæ–¹å‘")

    @validator("sort_order")
    def validate_sort_order(cls, v):
        if v not in ["asc", "desc"]:
            raise ValueError("æ’åºæ–¹å‘å¿…é¡»æ˜¯ asc æˆ– desc")
        return v


class UserResponse(BaseModel):
    """ç”¨æˆ·å“åº”æ¨¡å¼ï¼ˆä¸åŒ…å«å¯†ç ï¼‰"""
    id: str
    username: str
    email: Optional[str]
    role: str
    is_active: bool
    created_at: datetime
    last_login: Optional[datetime]

    class Config:
        from_attributes = True


class UserDetailResponse(UserResponse):
    """ç”¨æˆ·è¯¦æƒ…å“åº”ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼‰"""
    updated_at: datetime
    statistics: Optional[dict] = None


class UserListResponse(BaseModel):
    """ç”¨æˆ·åˆ—è¡¨å“åº”"""
    users: list[UserResponse]
    pagination: dict


# ============ åˆ›å»ºç”¨æˆ·ç›¸å…³ ============

class CreateUserRequest(BaseModel):
    """åˆ›å»ºç”¨æˆ·è¯·æ±‚"""
    username: str = Field(..., min_length=3, max_length=32)
    email: EmailStr
    password: str = Field(..., min_length=8)
    role: str = Field(default="user")

    @validator("username")
    def validate_username(cls, v):
        if not re.match(r"^[a-zA-Z0-9_]+$", v):
            raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
        return v

    @validator("password")
    def validate_password(cls, v):
        if not re.search(r"[a-z]", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯")
        if not re.search(r"[A-Z]", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯")
        if not re.search(r"\d", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«æ•°å­—")
        return v

    @validator("role")
    def validate_role(cls, v):
        if v not in ["user", "admin"]:
            raise ValueError("è§’è‰²å¿…é¡»æ˜¯ user æˆ– admin")
        return v


# ============ æ›´æ–°ç”¨æˆ·ç›¸å…³ ============

class UpdateUserRequest(BaseModel):
    """æ›´æ–°ç”¨æˆ·è¯·æ±‚"""
    username: Optional[str] = Field(None, min_length=3, max_length=32)
    email: Optional[EmailStr] = None
    role: Optional[str] = None
    is_active: Optional[bool] = None

    @validator("username")
    def validate_username(cls, v):
        if v is not None and not re.match(r"^[a-zA-Z0-9_]+$", v):
            raise ValueError("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
        return v

    @validator("role")
    def validate_role(cls, v):
        if v is not None and v not in ["user", "admin"]:
            raise ValueError("è§’è‰²å¿…é¡»æ˜¯ user æˆ– admin")
        return v


# ============ é‡ç½®å¯†ç ç›¸å…³ ============

class ResetPasswordRequest(BaseModel):
    """é‡ç½®å¯†ç è¯·æ±‚"""
    new_password: str = Field(..., min_length=8)

    @validator("new_password")
    def validate_password(cls, v):
        if not re.search(r"[a-z]", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯")
        if not re.search(r"[A-Z]", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯")
        if not re.search(r"\d", v):
            raise ValueError("å¯†ç å¿…é¡»åŒ…å«æ•°å­—")
        return v


# ============ æ‰¹é‡æ“ä½œç›¸å…³ ============

class BatchDeleteRequest(BaseModel):
    """æ‰¹é‡åˆ é™¤è¯·æ±‚"""
    user_ids: list[str] = Field(..., min_items=1)
    cascade: bool = Field(default=True, description="æ˜¯å¦çº§è”åˆ é™¤å…³è”æ•°æ®")
```

### 5.4 åˆ›å»ºä¾èµ–é¡¹ï¼ˆæƒé™éªŒè¯ï¼‰

**æ–‡ä»¶**: `backend/app/api/v1/deps.py`ï¼ˆæ‰©å±•ç°æœ‰æ–‡ä»¶ï¼‰

```python
# åœ¨ç°æœ‰ä»£ç åŸºç¡€ä¸Šæ·»åŠ 

from fastapi import Depends, HTTPException, status

async def require_admin(
    current_user: User = Depends(get_current_user)
) -> User:
    """è¦æ±‚ç®¡ç†å‘˜æƒé™"""
    if current_user.role != "admin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="éœ€è¦ç®¡ç†å‘˜æƒé™"
        )
    return current_user
```

### 5.5 å®ç°ç®¡ç†å‘˜è·¯ç”±

**æ–‡ä»¶**: `backend/app/api/v1/routers/admin.py`ï¼ˆå®Œå…¨é‡å†™ï¼‰

```python
from fastapi import APIRouter, Depends, HTTPException, status, Query
from typing import Optional
from app.api.v1.deps import require_admin
from app.models.user import User
from app.models.conversation import Conversation
from app.models.transcript import Transcript
from app.schemas.admin import (
    UserListQuery,
    UserResponse,
    UserDetailResponse,
    UserListResponse,
    CreateUserRequest,
    UpdateUserRequest,
    ResetPasswordRequest,
    BatchDeleteRequest,
)
from app.core.security import hash_password
from tortoise.expressions import Q
import math

router = APIRouter(prefix="/admin", tags=["admin"])


# ============ è·å–ç”¨æˆ·åˆ—è¡¨ ============

@router.get("/users", response_model=dict)
async def get_users(
    page: int = Query(default=1, ge=1, description="é¡µç "),
    limit: int = Query(default=20, ge=1, le=100, description="æ¯é¡µæ•°é‡"),
    search: Optional[str] = Query(default=None, description="æœç´¢å…³é”®è¯"),
    role: Optional[str] = Query(default=None, description="è§’è‰²è¿‡æ»¤"),
    sort_by: str = Query(default="created_at", description="æ’åºå­—æ®µ"),
    sort_order: str = Query(default="desc", description="æ’åºæ–¹å‘"),
    admin_user: User = Depends(require_admin)
):
    """
    è·å–ç”¨æˆ·åˆ—è¡¨
    - æ”¯æŒåˆ†é¡µ
    - æ”¯æŒæœç´¢ï¼ˆç”¨æˆ·åæˆ–é‚®ç®±ï¼‰
    - æ”¯æŒè§’è‰²è¿‡æ»¤
    - æ”¯æŒæ’åº
    """
    # æ„å»ºæŸ¥è¯¢
    query = User.all()

    # æœç´¢è¿‡æ»¤
    if search:
        query = query.filter(
            Q(username__icontains=search) | Q(email__icontains=search)
        )

    # è§’è‰²è¿‡æ»¤
    if role:
        query = query.filter(role=role)

    # è·å–æ€»æ•°
    total = await query.count()

    # æ’åº
    if sort_order == "desc":
        sort_by = f"-{sort_by}"
    query = query.order_by(sort_by)

    # åˆ†é¡µ
    offset = (page - 1) * limit
    users = await query.offset(offset).limit(limit)

    # åºåˆ—åŒ–ï¼ˆç§»é™¤å¯†ç å­—æ®µï¼‰
    user_list = [
        UserResponse(
            id=str(user.id),
            username=user.username,
            email=user.email,
            role=user.role,
            is_active=user.is_active,
            created_at=user.created_at,
            last_login=user.last_login,
        )
        for user in users
    ]

    # åˆ†é¡µä¿¡æ¯
    total_pages = math.ceil(total / limit)

    return {
        "success": True,
        "data": {
            "users": [user.dict() for user in user_list],
            "pagination": {
                "total": total,
                "page": page,
                "pageSize": limit,
                "totalPages": total_pages,
            }
        }
    }


# ============ è·å–ç”¨æˆ·è¯¦æƒ… ============

@router.get("/users/{user_id}", response_model=dict)
async def get_user_detail(
    user_id: str,
    admin_user: User = Depends(require_admin)
):
    """
    è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
    - åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    - åŒ…å«ç»Ÿè®¡æ•°æ®ï¼ˆä¼šè¯æ•°ã€å¯¹è¯æ•°ï¼‰
    """
    # æŸ¥è¯¢ç”¨æˆ·
    user = await User.get_or_none(id=user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )

    # æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
    conversation_count = await Conversation.filter(user_id=user_id).count()
    transcript_count = await Transcript.filter(
        conversation__user_id=user_id
    ).count()

    # æ„å»ºå“åº”
    user_detail = UserDetailResponse(
        id=str(user.id),
        username=user.username,
        email=user.email,
        role=user.role,
        is_active=user.is_active,
        created_at=user.created_at,
        updated_at=user.updated_at,
        last_login=user.last_login,
        statistics={
            "total_conversations": conversation_count,
            "total_transcripts": transcript_count,
            "last_activity": user.last_login,
        }
    )

    return {
        "success": True,
        "data": user_detail.dict()
    }


# ============ åˆ›å»ºç”¨æˆ· ============

@router.post("/users", response_model=dict, status_code=status.HTTP_201_CREATED)
async def create_user(
    data: CreateUserRequest,
    admin_user: User = Depends(require_admin)
):
    """
    åˆ›å»ºæ–°ç”¨æˆ·
    - éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
    - éªŒè¯é‚®ç®±å”¯ä¸€æ€§
    - éªŒè¯å¯†ç å¼ºåº¦
    - å“ˆå¸Œå¯†ç 
    """
    # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    if await User.exists(username=data.username):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={
                "code": "USERNAME_EXISTS",
                "message": "ç”¨æˆ·åå·²å­˜åœ¨",
                "field": "username"
            }
        )

    # æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
    if await User.exists(email=data.email):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail={
                "code": "EMAIL_EXISTS",
                "message": "é‚®ç®±å·²è¢«æ³¨å†Œ",
                "field": "email"
            }
        )

    # åˆ›å»ºç”¨æˆ·
    user = await User.create(
        username=data.username,
        email=data.email,
        password_hash=hash_password(data.password),
        role=data.role,
        is_active=True,
    )

    return {
        "success": True,
        "data": UserResponse(
            id=str(user.id),
            username=user.username,
            email=user.email,
            role=user.role,
            is_active=user.is_active,
            created_at=user.created_at,
            last_login=None,
        ).dict(),
        "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ"
    }


# ============ æ›´æ–°ç”¨æˆ·ä¿¡æ¯ ============

@router.put("/users/{user_id}", response_model=dict)
async def update_user(
    user_id: str,
    data: UpdateUserRequest,
    admin_user: User = Depends(require_admin)
):
    """
    æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    - å¯æ›´æ–°ç”¨æˆ·åã€é‚®ç®±ã€è§’è‰²ã€çŠ¶æ€
    - éªŒè¯æ•°æ®å”¯ä¸€æ€§
    - é˜²æŠ¤ï¼šä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜çš„æƒé™
    """
    # æŸ¥è¯¢ç”¨æˆ·
    user = await User.get_or_none(id=user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )

    # æ›´æ–°ç”¨æˆ·å
    if data.username and data.username != user.username:
        if await User.exists(username=data.username):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ç”¨æˆ·åå·²å­˜åœ¨"
            )
        user.username = data.username

    # æ›´æ–°é‚®ç®±
    if data.email and data.email != user.email:
        if await User.exists(email=data.email):
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="é‚®ç®±å·²è¢«ä½¿ç”¨"
            )
        user.email = data.email

    # æ›´æ–°è§’è‰²ï¼ˆéœ€è¦æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªç®¡ç†å‘˜ï¼‰
    if data.role and data.role != user.role:
        if user.role == "admin" and data.role != "admin":
            # æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€ä¸ªç®¡ç†å‘˜
            admin_count = await User.filter(role="admin").count()
            if admin_count <= 1:
                raise HTTPException(
                    status_code=status.HTTP_409_CONFLICT,
                    detail={
                        "code": "CANNOT_DEMOTE_LAST_ADMIN",
                        "message": "ä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜çš„ç®¡ç†å‘˜æƒé™"
                    }
                )
        user.role = data.role

    # æ›´æ–°çŠ¶æ€
    if data.is_active is not None:
        user.is_active = data.is_active

    # ä¿å­˜æ›´æ–°
    await user.save()

    return {
        "success": True,
        "data": UserResponse(
            id=str(user.id),
            username=user.username,
            email=user.email,
            role=user.role,
            is_active=user.is_active,
            created_at=user.created_at,
            last_login=user.last_login,
        ).dict(),
        "message": "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ"
    }


# ============ é‡ç½®ç”¨æˆ·å¯†ç  ============

@router.post("/users/{user_id}/reset-password", response_model=dict)
async def reset_user_password(
    user_id: str,
    data: ResetPasswordRequest,
    admin_user: User = Depends(require_admin)
):
    """
    é‡ç½®ç”¨æˆ·å¯†ç 
    - ç®¡ç†å‘˜å¯ä»¥ä¸ºä»»ä½•ç”¨æˆ·é‡ç½®å¯†ç 
    - æ–°å¯†ç å¿…é¡»æ»¡è¶³å¼ºåº¦è¦æ±‚
    """
    # æŸ¥è¯¢ç”¨æˆ·
    user = await User.get_or_none(id=user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )

    # æ›´æ–°å¯†ç 
    user.password_hash = hash_password(data.new_password)
    await user.save()

    return {
        "success": True,
        "message": "å¯†ç é‡ç½®æˆåŠŸ",
        "data": {
            "user_id": str(user.id),
            "username": user.username,
            "password_changed_at": user.updated_at,
        }
    }


# ============ åˆ é™¤ç”¨æˆ· ============

@router.delete("/users/{user_id}", response_model=dict)
async def delete_user(
    user_id: str,
    cascade: bool = Query(default=True, description="æ˜¯å¦çº§è”åˆ é™¤å…³è”æ•°æ®"),
    admin_user: User = Depends(require_admin)
):
    """
    åˆ é™¤ç”¨æˆ·
    - é˜²æŠ¤ï¼šä¸èƒ½åˆ é™¤è‡ªå·±
    - é˜²æŠ¤ï¼šä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
    - å¯é€‰çº§è”åˆ é™¤å…³è”æ•°æ®ï¼ˆä¼šè¯ã€å¯¹è¯ï¼‰
    """
    # æŸ¥è¯¢ç”¨æˆ·
    user = await User.get_or_none(id=user_id)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="ç”¨æˆ·ä¸å­˜åœ¨"
        )

    # é˜²æŠ¤ï¼šä¸èƒ½åˆ é™¤è‡ªå·±
    if str(user.id) == str(admin_user.id):
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail={
                "code": "CANNOT_DELETE_SELF",
                "message": "ä¸èƒ½åˆ é™¤è‡ªå·±çš„è´¦æˆ·"
            }
        )

    # é˜²æŠ¤ï¼šä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
    if user.role == "admin":
        admin_count = await User.filter(role="admin").count()
        if admin_count <= 1:
            raise HTTPException(
                status_code=status.HTTP_409_CONFLICT,
                detail={
                    "code": "CANNOT_DELETE_LAST_ADMIN",
                    "message": "ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·"
                }
            )

    # çº§è”åˆ é™¤å…³è”æ•°æ®
    deleted_conversations = 0
    deleted_transcripts = 0

    if cascade:
        # åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
        conversations = await Conversation.filter(user_id=user_id)
        for conv in conversations:
            # åˆ é™¤å¯¹è¯çš„æ‰€æœ‰ transcript
            transcript_count = await Transcript.filter(conversation_id=conv.id).delete()
            deleted_transcripts += transcript_count
            await conv.delete()
            deleted_conversations += 1

    # åˆ é™¤ç”¨æˆ·
    await user.delete()

    return {
        "success": True,
        "message": "ç”¨æˆ·åˆ é™¤æˆåŠŸ",
        "data": {
            "deleted_user_id": str(user_id),
            "deleted_conversations": deleted_conversations,
            "deleted_transcripts": deleted_transcripts,
            "deleted_at": user.updated_at,
        }
    }


# ============ æ‰¹é‡åˆ é™¤ç”¨æˆ· ============

@router.post("/users/batch-delete", response_model=dict)
async def batch_delete_users(
    data: BatchDeleteRequest,
    admin_user: User = Depends(require_admin)
):
    """
    æ‰¹é‡åˆ é™¤ç”¨æˆ·
    - éµå¾ªå•ä¸ªåˆ é™¤çš„æ‰€æœ‰é˜²æŠ¤è§„åˆ™
    - è¿”å›æ¯ä¸ªç”¨æˆ·çš„åˆ é™¤ç»“æœ
    """
    results = []
    succeeded = 0
    failed = 0

    for user_id in data.user_ids:
        try:
            # æŸ¥è¯¢ç”¨æˆ·
            user = await User.get_or_none(id=user_id)
            if not user:
                results.append({
                    "user_id": user_id,
                    "status": "failed",
                    "message": "ç”¨æˆ·ä¸å­˜åœ¨"
                })
                failed += 1
                continue

            # é˜²æŠ¤æ£€æŸ¥
            if str(user.id) == str(admin_user.id):
                results.append({
                    "user_id": user_id,
                    "status": "failed",
                    "message": "ä¸èƒ½åˆ é™¤è‡ªå·±"
                })
                failed += 1
                continue

            if user.role == "admin":
                admin_count = await User.filter(role="admin").count()
                if admin_count <= 1:
                    results.append({
                        "user_id": user_id,
                        "status": "failed",
                        "message": "ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜"
                    })
                    failed += 1
                    continue

            # çº§è”åˆ é™¤
            if data.cascade:
                conversations = await Conversation.filter(user_id=user_id)
                for conv in conversations:
                    await Transcript.filter(conversation_id=conv.id).delete()
                    await conv.delete()

            # åˆ é™¤ç”¨æˆ·
            await user.delete()

            results.append({
                "user_id": user_id,
                "status": "success",
                "message": "åˆ é™¤æˆåŠŸ"
            })
            succeeded += 1

        except Exception as e:
            results.append({
                "user_id": user_id,
                "status": "failed",
                "message": str(e)
            })
            failed += 1

    return {
        "success": True,
        "message": "æ‰¹é‡åˆ é™¤å®Œæˆ",
        "data": {
            "total": len(data.user_ids),
            "succeeded": succeeded,
            "failed": failed,
            "results": results
        }
    }
```

### 5.6 æ•°æ®åº“è¿ç§»

ç”±äºæ·»åŠ äº†æ–°å­—æ®µï¼Œéœ€è¦æ›´æ–°æ•°æ®åº“è¡¨ç»“æ„ï¼š

**åˆ›å»ºè¿ç§»è„šæœ¬**: `backend/update_user_table.py`

```python
#!/usr/bin/env python3
"""
æ›´æ–° users è¡¨ç»“æ„
æ·»åŠ  is_active, updated_at, last_login å­—æ®µ
"""
import asyncio
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from tortoise import Tortoise

async def migrate():
    """æ‰§è¡Œæ•°æ®åº“è¿ç§»"""
    await Tortoise.init(
        db_url='sqlite://./systemx.db',
        modules={'models': ['app.models.user']}
    )

    conn = Tortoise.get_connection("default")

    # æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
    check_columns = await conn.execute_query(
        "PRAGMA table_info(users);"
    )
    existing_columns = [col[1] for col in check_columns[1]]

    print(f"ç°æœ‰å­—æ®µ: {existing_columns}")

    # æ·»åŠ æ–°å­—æ®µ
    if 'is_active' not in existing_columns:
        await conn.execute_query(
            "ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT 1;"
        )
        print("âœ… æ·»åŠ  is_active å­—æ®µ")

    if 'updated_at' not in existing_columns:
        await conn.execute_query(
            "ALTER TABLE users ADD COLUMN updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP;"
        )
        print("âœ… æ·»åŠ  updated_at å­—æ®µ")

    if 'last_login' not in existing_columns:
        await conn.execute_query(
            "ALTER TABLE users ADD COLUMN last_login TIMESTAMP NULL;"
        )
        print("âœ… æ·»åŠ  last_login å­—æ®µ")

    # ä¸º email æ·»åŠ å”¯ä¸€ç´¢å¼•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    try:
        await conn.execute_query(
            "CREATE UNIQUE INDEX IF NOT EXISTS idx_users_email ON users(email);"
        )
        print("âœ… æ·»åŠ  email å”¯ä¸€ç´¢å¼•")
    except:
        print("âš ï¸  email ç´¢å¼•å·²å­˜åœ¨")

    await Tortoise.close_connections()
    print("\nâœ¨ æ•°æ®åº“è¿ç§»å®Œæˆï¼")

if __name__ == "__main__":
    print("ğŸš€ å¼€å§‹æ•°æ®åº“è¿ç§»...")
    asyncio.run(migrate())
```

**æ‰§è¡Œè¿ç§»**:
```bash
cd backend
source venv/bin/activate
python3 update_user_table.py
```

---

## 6. å‰ç«¯å®ç°

### 6.1 å‰ç«¯ç›®å½•ç»“æ„

```
frontend/src/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ admin.js                    # ç®¡ç†å‘˜ API å®¢æˆ·ç«¯ï¼ˆæ–°å»ºï¼‰
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Admin/
â”‚   â”‚   â”œâ”€â”€ UserManagement/
â”‚   â”‚   â”‚   â”œâ”€â”€ UserManagement.jsx          # ç”¨æˆ·åˆ—è¡¨é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ UserManagement.module.css
â”‚   â”‚   â”‚   â”œâ”€â”€ UserDetail.jsx              # ç”¨æˆ·è¯¦æƒ…ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateUserModal.jsx         # åˆ›å»ºç”¨æˆ·å¯¹è¯æ¡†
â”‚   â”‚   â”‚   â”œâ”€â”€ EditUserModal.jsx           # ç¼–è¾‘ç”¨æˆ·å¯¹è¯æ¡†
â”‚   â”‚   â”‚   â””â”€â”€ ResetPasswordModal.jsx      # é‡ç½®å¯†ç å¯¹è¯æ¡†
â”‚   â”‚   â””â”€â”€ AdminLayout/
â”‚   â”‚       â”œâ”€â”€ AdminLayout.jsx             # ç®¡ç†å‘˜å¸ƒå±€
â”‚   â”‚       â””â”€â”€ AdminLayout.module.css
â”‚   â””â”€â”€ Dashboard/
â”‚       â””â”€â”€ Dashboard.jsx                   # ä»ªè¡¨æ¿ï¼ˆæ£€æµ‹ç®¡ç†å‘˜è§’è‰²ï¼‰
â””â”€â”€ components/
    â”œâ”€â”€ ProtectedRoute.jsx                  # è·¯ç”±ä¿æŠ¤ç»„ä»¶ï¼ˆæ–°å»ºï¼‰
    â””â”€â”€ AdminRoute.jsx                      # ç®¡ç†å‘˜è·¯ç”±ä¿æŠ¤ï¼ˆæ–°å»ºï¼‰
```

### 6.2 åˆ›å»ºç®¡ç†å‘˜ API å®¢æˆ·ç«¯

**æ–‡ä»¶**: `frontend/src/api/admin.js`ï¼ˆæ–°å»ºï¼‰

```javascript
// src/api/admin.js
const BASE_URL = import.meta.env.VITE_API_BASE_URL + "/api/v1/admin";

async function api(path, { method = "GET", body, params } = {}) {
  // æ„å»º URL
  let url = `${BASE_URL}${path}`;

  // æ·»åŠ æŸ¥è¯¢å‚æ•°
  if (params) {
    const query = new URLSearchParams(params).toString();
    url += `?${query}`;
  }

  const res = await fetch(url, {
    method,
    headers: body ? { "Content-Type": "application/json" } : undefined,
    body: body ? JSON.stringify(body) : undefined,
    credentials: "include", // å¸¦ä¸Š HttpOnly Cookie
  });

  let data = null;
  try {
    data = await res.json();
  } catch (_) {}

  if (!res.ok || (data && data.success === false)) {
    const msg = data?.error?.message || data?.detail || `HTTP ${res.status}`;
    return { ok: false, message: msg, code: data?.error?.code };
  }

  return { ok: true, data: data?.data ?? data };
}

/**
 * è·å–ç”¨æˆ·åˆ—è¡¨
 */
export async function getUserList(params = {}) {
  const defaultParams = {
    page: 1,
    limit: 20,
    ...params
  };
  return await api("/users", { method: "GET", params: defaultParams });
}

/**
 * è·å–ç”¨æˆ·è¯¦æƒ…
 */
export async function getUserDetail(userId) {
  return await api(`/users/${userId}`, { method: "GET" });
}

/**
 * åˆ›å»ºç”¨æˆ·
 */
export async function createUser(userData) {
  return await api("/users", { method: "POST", body: userData });
}

/**
 * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
 */
export async function updateUser(userId, updates) {
  return await api(`/users/${userId}`, { method: "PUT", body: updates });
}

/**
 * é‡ç½®ç”¨æˆ·å¯†ç 
 */
export async function resetUserPassword(userId, newPassword) {
  return await api(`/users/${userId}/reset-password`, {
    method: "POST",
    body: { new_password: newPassword }
  });
}

/**
 * åˆ é™¤ç”¨æˆ·
 */
export async function deleteUser(userId, cascade = true) {
  return await api(`/users/${userId}`, {
    method: "DELETE",
    params: { cascade }
  });
}

/**
 * æ‰¹é‡åˆ é™¤ç”¨æˆ·
 */
export async function batchDeleteUsers(userIds, cascade = true) {
  return await api("/users/batch-delete", {
    method: "POST",
    body: { user_ids: userIds, cascade }
  });
}
```

### 6.3 åˆ›å»ºè·¯ç”±ä¿æŠ¤ç»„ä»¶

**æ–‡ä»¶**: `frontend/src/components/AdminRoute.jsx`ï¼ˆæ–°å»ºï¼‰

```javascript
// src/components/AdminRoute.jsx
import { Navigate } from 'react-router-dom';

/**
 * ç®¡ç†å‘˜è·¯ç”±ä¿æŠ¤ç»„ä»¶
 * åªå…è®¸è§’è‰²ä¸º admin çš„ç”¨æˆ·è®¿é—®
 */
export default function AdminRoute({ children }) {
  // ä» localStorage æˆ– context è·å–ç”¨æˆ·ä¿¡æ¯
  const userStr = localStorage.getItem('user');
  const user = userStr ? JSON.parse(userStr) : null;

  // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
  if (!user) {
    return <Navigate to="/login" replace />;
  }

  // éç®¡ç†å‘˜ï¼Œé‡å®šå‘åˆ°ä»ªè¡¨æ¿
  if (user.role !== 'admin') {
    return <Navigate to="/dashboard" replace />;
  }

  // æ˜¯ç®¡ç†å‘˜ï¼Œå…è®¸è®¿é—®
  return children;
}
```

### 6.4 ç”¨æˆ·ç®¡ç†é¡µé¢å®ç°

**æ–‡ä»¶**: `frontend/src/pages/Admin/UserManagement/UserManagement.jsx`ï¼ˆæ–°å»ºï¼‰

```javascript
// src/pages/Admin/UserManagement/UserManagement.jsx
import { useState, useEffect } from 'react';
import {
  getUserList,
  deleteUser,
  batchDeleteUsers
} from '../../../api/admin';
import CreateUserModal from './CreateUserModal';
import EditUserModal from './EditUserModal';
import ResetPasswordModal from './ResetPasswordModal';
import styles from './UserManagement.module.css';

export default function UserManagement() {
  // çŠ¶æ€ç®¡ç†
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({
    page: 1,
    pageSize: 20,
    total: 0,
    totalPages: 0
  });
  const [search, setSearch] = useState('');
  const [roleFilter, setRoleFilter] = useState('');
  const [selectedUsers, setSelectedUsers] = useState(new Set());

  // å¯¹è¯æ¡†çŠ¶æ€
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [showResetPasswordModal, setShowResetPasswordModal] = useState(false);
  const [currentUser, setCurrentUser] = useState(null);

  // åŠ è½½ç”¨æˆ·åˆ—è¡¨
  const loadUsers = async () => {
    setLoading(true);
    const params = {
      page: pagination.page,
      limit: pagination.pageSize,
    };

    if (search) params.search = search;
    if (roleFilter) params.role = roleFilter;

    const result = await getUserList(params);

    if (result.ok) {
      setUsers(result.data.users);
      setPagination(result.data.pagination);
    } else {
      alert(`åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${result.message}`);
    }

    setLoading(false);
  };

  // åˆå§‹åŠ è½½
  useEffect(() => {
    loadUsers();
  }, [pagination.page, roleFilter]);

  // æœç´¢å¤„ç†
  const handleSearch = (e) => {
    e.preventDefault();
    setPagination({ ...pagination, page: 1 });
    loadUsers();
  };

  // åˆ é™¤å•ä¸ªç”¨æˆ·
  const handleDeleteUser = async (userId, username) => {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
      return;
    }

    const result = await deleteUser(userId, true);

    if (result.ok) {
      alert('ç”¨æˆ·åˆ é™¤æˆåŠŸ');
      loadUsers();
    } else {
      alert(`åˆ é™¤å¤±è´¥: ${result.message}`);
    }
  };

  // æ‰¹é‡åˆ é™¤
  const handleBatchDelete = async () => {
    if (selectedUsers.size === 0) {
      alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„ç”¨æˆ·');
      return;
    }

    if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
      return;
    }

    const result = await batchDeleteUsers(Array.from(selectedUsers), true);

    if (result.ok) {
      const { succeeded, failed } = result.data;
      alert(`æ‰¹é‡åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${succeeded} ä¸ªï¼Œå¤±è´¥ ${failed} ä¸ª`);
      setSelectedUsers(new Set());
      loadUsers();
    } else {
      alert(`æ‰¹é‡åˆ é™¤å¤±è´¥: ${result.message}`);
    }
  };

  // ç¼–è¾‘ç”¨æˆ·
  const handleEditUser = (user) => {
    setCurrentUser(user);
    setShowEditModal(true);
  };

  // é‡ç½®å¯†ç 
  const handleResetPassword = (user) => {
    setCurrentUser(user);
    setShowResetPasswordModal(true);
  };

  // å¤é€‰æ¡†å¤„ç†
  const handleSelectUser = (userId) => {
    const newSelected = new Set(selectedUsers);
    if (newSelected.has(userId)) {
      newSelected.delete(userId);
    } else {
      newSelected.add(userId);
    }
    setSelectedUsers(newSelected);
  };

  // å…¨é€‰
  const handleSelectAll = () => {
    if (selectedUsers.size === users.length) {
      setSelectedUsers(new Set());
    } else {
      setSelectedUsers(new Set(users.map(u => u.id)));
    }
  };

  return (
    <div className={styles.container}>
      <div className={styles.header}>
        <h1>ç”¨æˆ·ç®¡ç†</h1>

        {/* æœç´¢å’Œè¿‡æ»¤ */}
        <div className={styles.toolbar}>
          <form onSubmit={handleSearch} className={styles.searchForm}>
            <input
              type="text"
              placeholder="æœç´¢ç”¨æˆ·åæˆ–é‚®ç®±..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className={styles.searchInput}
            />
            <button type="submit" className={styles.searchButton}>
              ğŸ” æœç´¢
            </button>
          </form>

          <select
            value={roleFilter}
            onChange={(e) => setRoleFilter(e.target.value)}
            className={styles.roleFilter}
          >
            <option value="">æ‰€æœ‰è§’è‰²</option>
            <option value="user">ç”¨æˆ·</option>
            <option value="admin">ç®¡ç†å‘˜</option>
          </select>

          <button
            onClick={() => setShowCreateModal(true)}
            className={styles.createButton}
          >
            + æ·»åŠ ç”¨æˆ·
          </button>
        </div>
      </div>

      {/* æ‰¹é‡æ“ä½œ */}
      {selectedUsers.size > 0 && (
        <div className={styles.batchActions}>
          <span>å·²é€‰æ‹© {selectedUsers.size} ä¸ªç”¨æˆ·</span>
          <button onClick={handleBatchDelete} className={styles.dangerButton}>
            æ‰¹é‡åˆ é™¤
          </button>
          <button onClick={() => setSelectedUsers(new Set())}>
            å–æ¶ˆé€‰æ‹©
          </button>
        </div>
      )}

      {/* ç”¨æˆ·åˆ—è¡¨ */}
      {loading ? (
        <div className={styles.loading}>åŠ è½½ä¸­...</div>
      ) : (
        <table className={styles.table}>
          <thead>
            <tr>
              <th>
                <input
                  type="checkbox"
                  checked={selectedUsers.size === users.length && users.length > 0}
                  onChange={handleSelectAll}
                />
              </th>
              <th>ç”¨æˆ·å</th>
              <th>é‚®ç®±</th>
              <th>è§’è‰²</th>
              <th>çŠ¶æ€</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æœ€åç™»å½•</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {users.map((user) => (
              <tr key={user.id}>
                <td>
                  <input
                    type="checkbox"
                    checked={selectedUsers.has(user.id)}
                    onChange={() => handleSelectUser(user.id)}
                  />
                </td>
                <td>{user.username}</td>
                <td>{user.email || '-'}</td>
                <td>
                  <span className={user.role === 'admin' ? styles.adminBadge : styles.userBadge}>
                    {user.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}
                  </span>
                </td>
                <td>
                  <span className={user.is_active ? styles.activeBadge : styles.inactiveBadge}>
                    {user.is_active ? 'æ­£å¸¸' : 'ç¦ç”¨'}
                  </span>
                </td>
                <td>{new Date(user.created_at).toLocaleDateString()}</td>
                <td>{user.last_login ? new Date(user.last_login).toLocaleDateString() : '-'}</td>
                <td className={styles.actions}>
                  <button
                    onClick={() => handleEditUser(user)}
                    className={styles.editButton}
                    title="ç¼–è¾‘"
                  >
                    âœï¸
                  </button>
                  <button
                    onClick={() => handleResetPassword(user)}
                    className={styles.resetButton}
                    title="é‡ç½®å¯†ç "
                  >
                    ğŸ”‘
                  </button>
                  <button
                    onClick={() => handleDeleteUser(user.id, user.username)}
                    className={styles.deleteButton}
                    title="åˆ é™¤"
                  >
                    ğŸ—‘ï¸
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}

      {/* åˆ†é¡µ */}
      <div className={styles.pagination}>
        <button
          onClick={() => setPagination({ ...pagination, page: pagination.page - 1 })}
          disabled={pagination.page === 1}
        >
          ä¸Šä¸€é¡µ
        </button>
        <span>
          ç¬¬ {pagination.page} / {pagination.totalPages} é¡µï¼ˆå…± {pagination.total} ä¸ªç”¨æˆ·ï¼‰
        </span>
        <button
          onClick={() => setPagination({ ...pagination, page: pagination.page + 1 })}
          disabled={pagination.page === pagination.totalPages}
        >
          ä¸‹ä¸€é¡µ
        </button>
      </div>

      {/* å¯¹è¯æ¡† */}
      {showCreateModal && (
        <CreateUserModal
          onClose={() => setShowCreateModal(false)}
          onSuccess={() => {
            setShowCreateModal(false);
            loadUsers();
          }}
        />
      )}

      {showEditModal && currentUser && (
        <EditUserModal
          user={currentUser}
          onClose={() => setShowEditModal(false)}
          onSuccess={() => {
            setShowEditModal(false);
            loadUsers();
          }}
        />
      )}

      {showResetPasswordModal && currentUser && (
        <ResetPasswordModal
          user={currentUser}
          onClose={() => setShowResetPasswordModal(false)}
          onSuccess={() => {
            setShowResetPasswordModal(false);
          }}
        />
      )}
    </div>
  );
}
```

### 6.5 åˆ›å»ºç”¨æˆ·å¯¹è¯æ¡†

**æ–‡ä»¶**: `frontend/src/pages/Admin/UserManagement/CreateUserModal.jsx`ï¼ˆæ–°å»ºï¼‰

```javascript
// src/pages/Admin/UserManagement/CreateUserModal.jsx
import { useState } from 'react';
import { createUser } from '../../../api/admin';
import styles from './Modal.module.css';

export default function CreateUserModal({ onClose, onSuccess }) {
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    password: '',
    confirmPassword: '',
    role: 'user'
  });
  const [errors, setErrors] = useState({});
  const [submitting, setSubmitting] = useState(false);

  const validateForm = () => {
    const newErrors = {};

    // ç”¨æˆ·åéªŒè¯
    if (!formData.username) {
      newErrors.username = 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º';
    } else if (!/^[a-zA-Z0-9_]{3,32}$/.test(formData.username)) {
      newErrors.username = 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-32å­—ç¬¦';
    }

    // é‚®ç®±éªŒè¯
    if (!formData.email) {
      newErrors.email = 'é‚®ç®±ä¸èƒ½ä¸ºç©º';
    } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formData.email)) {
      newErrors.email = 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®';
    }

    // å¯†ç éªŒè¯
    if (!formData.password) {
      newErrors.password = 'å¯†ç ä¸èƒ½ä¸ºç©º';
    } else if (formData.password.length < 8) {
      newErrors.password = 'å¯†ç è‡³å°‘8ä¸ªå­—ç¬¦';
    } else if (!/[a-z]/.test(formData.password)) {
      newErrors.password = 'å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯';
    } else if (!/[A-Z]/.test(formData.password)) {
      newErrors.password = 'å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯';
    } else if (!/\d/.test(formData.password)) {
      newErrors.password = 'å¯†ç å¿…é¡»åŒ…å«æ•°å­—';
    }

    // ç¡®è®¤å¯†ç éªŒè¯
    if (formData.password !== formData.confirmPassword) {
      newErrors.confirmPassword = 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!validateForm()) {
      return;
    }

    setSubmitting(true);

    const result = await createUser({
      username: formData.username,
      email: formData.email,
      password: formData.password,
      role: formData.role
    });

    setSubmitting(false);

    if (result.ok) {
      alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼');
      onSuccess();
    } else {
      alert(`åˆ›å»ºå¤±è´¥: ${result.message}`);
    }
  };

  return (
    <div className={styles.overlay}>
      <div className={styles.modal}>
        <div className={styles.header}>
          <h2>æ·»åŠ æ–°ç”¨æˆ·</h2>
          <button onClick={onClose} className={styles.closeButton}>
            Ã—
          </button>
        </div>

        <form onSubmit={handleSubmit} className={styles.form}>
          <div className={styles.formGroup}>
            <label>ç”¨æˆ·å *</label>
            <input
              type="text"
              value={formData.username}
              onChange={(e) => setFormData({ ...formData, username: e.target.value })}
              className={errors.username ? styles.inputError : ''}
            />
            {errors.username && <span className={styles.error}>{errors.username}</span>}
          </div>

          <div className={styles.formGroup}>
            <label>é‚®ç®± *</label>
            <input
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className={errors.email ? styles.inputError : ''}
            />
            {errors.email && <span className={styles.error}>{errors.email}</span>}
          </div>

          <div className={styles.formGroup}>
            <label>å¯†ç  *</label>
            <input
              type="password"
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className={errors.password ? styles.inputError : ''}
            />
            {errors.password && <span className={styles.error}>{errors.password}</span>}
          </div>

          <div className={styles.formGroup}>
            <label>ç¡®è®¤å¯†ç  *</label>
            <input
              type="password"
              value={formData.confirmPassword}
              onChange={(e) => setFormData({ ...formData, confirmPassword: e.target.value })}
              className={errors.confirmPassword ? styles.inputError : ''}
            />
            {errors.confirmPassword && <span className={styles.error}>{errors.confirmPassword}</span>}
          </div>

          <div className={styles.formGroup}>
            <label>è§’è‰²</label>
            <select
              value={formData.role}
              onChange={(e) => setFormData({ ...formData, role: e.target.value })}
            >
              <option value="user">ç”¨æˆ·</option>
              <option value="admin">ç®¡ç†å‘˜</option>
            </select>
          </div>

          <div className={styles.actions}>
            <button type="button" onClick={onClose}>
              å–æ¶ˆ
            </button>
            <button type="submit" disabled={submitting} className={styles.primaryButton}>
              {submitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºç”¨æˆ·'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
}
```

---

## 7. å®‰å…¨è€ƒè™‘

### 7.1 èº«ä»½éªŒè¯

- **JWT Token**: ä½¿ç”¨ HS256 ç®—æ³•ç­¾å
- **Token å­˜å‚¨**: HttpOnly Cookieï¼ˆé˜²æ­¢ XSSï¼‰
- **Token è¿‡æœŸ**: 1å°æ—¶è‡ªåŠ¨è¿‡æœŸ
- **åˆ·æ–°æœºåˆ¶**: å¯é€‰å®ç° Refresh Token

### 7.2 æƒé™æ§åˆ¶

- **åŸºäºè§’è‰²**: Admin / User ä¸¤çº§æƒé™
- **ä¸­é—´ä»¶éªŒè¯**: æ¯ä¸ªç®¡ç†å‘˜æ¥å£éƒ½éªŒè¯è§’è‰²
- **é˜²æŠ¤æœºåˆ¶**:
  - ä¸èƒ½åˆ é™¤è‡ªå·±
  - ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
  - ä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜çš„æƒé™

### 7.3 æ•°æ®éªŒè¯

- **åç«¯éªŒè¯**: Pydantic æ¨¡å¼éªŒè¯æ‰€æœ‰è¾“å…¥
- **å‰ç«¯éªŒè¯**: æå‰éªŒè¯ï¼Œæä¾›å³æ—¶åé¦ˆ
- **åŒé‡éªŒè¯**: å‰åç«¯éƒ½éªŒè¯ï¼Œé˜²æ­¢ç»•è¿‡

### 7.4 å¯†ç å®‰å…¨

- **å“ˆå¸Œç®—æ³•**: Argon2ï¼ˆæœ€å®‰å…¨çš„å¯†ç å“ˆå¸Œï¼‰
- **å¯†ç å¼ºåº¦**: è‡³å°‘8å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
- **é˜²æš´åŠ›ç ´è§£**: å¯æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶

### 7.5 SQL æ³¨å…¥é˜²æŠ¤

- **ORM æŸ¥è¯¢**: Tortoise ORM è‡ªåŠ¨é˜²æŠ¤
- **å‚æ•°åŒ–æŸ¥è¯¢**: æ‰€æœ‰æŸ¥è¯¢ä½¿ç”¨å‚æ•°ç»‘å®š
- **è¾“å…¥è¿‡æ»¤**: ç”¨æˆ·ååªå…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿

### 7.6 CORS é…ç½®

- **ç™½åå•**: åªå…è®¸æŒ‡å®šçš„å‰ç«¯åŸŸå
- **å‡­è¯æ”¯æŒ**: `allow_credentials=True`
- **ç”Ÿäº§ç¯å¢ƒ**: é…ç½®å…·ä½“çš„åŸŸåï¼Œä¸ä½¿ç”¨ `*`

---

## 8. æµ‹è¯•æ–¹æ¡ˆ

### 8.1 åç«¯ API æµ‹è¯•

**ä½¿ç”¨ curl æµ‹è¯•**:

```bash
# 1. ç®¡ç†å‘˜ç™»å½•è·å– token
TOKEN=$(curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  -c cookies.txt \
  | jq -r '.data.accessToken')

# 2. è·å–ç”¨æˆ·åˆ—è¡¨
curl -X GET "http://localhost:8000/api/v1/admin/users?page=1&limit=10" \
  -H "Authorization: Bearer $TOKEN" \
  -b cookies.txt

# 3. åˆ›å»ºç”¨æˆ·
curl -X POST http://localhost:8000/api/v1/admin/users \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "TestPass123",
    "role": "user"
  }'

# 4. æ›´æ–°ç”¨æˆ·
curl -X PUT http://localhost:8000/api/v1/admin/users/{user_id} \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"role": "admin"}'

# 5. åˆ é™¤ç”¨æˆ·
curl -X DELETE http://localhost:8000/api/v1/admin/users/{user_id} \
  -H "Authorization: Bearer $TOKEN" \
  -b cookies.txt
```

### 8.2 å•å…ƒæµ‹è¯•

**æµ‹è¯•æ–‡ä»¶**: `backend/app/tests/test_admin.py`

```python
import pytest
from httpx import AsyncClient
from app.main import app

@pytest.mark.asyncio
async def test_admin_get_users():
    """æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        # ç™»å½•ç®¡ç†å‘˜
        login_res = await client.post("/api/v1/auth/login", json={
            "username": "admin",
            "password": "admin123"
        })
        assert login_res.status_code == 200
        token = login_res.json()["data"]["accessToken"]

        # è·å–ç”¨æˆ·åˆ—è¡¨
        res = await client.get(
            "/api/v1/admin/users",
            headers={"Authorization": f"Bearer {token}"}
        )
        assert res.status_code == 200
        data = res.json()
        assert data["success"] is True
        assert "users" in data["data"]
```

### 8.3 å‰ç«¯æµ‹è¯•

**æ‰‹åŠ¨æµ‹è¯•æ¸…å•**:

- [ ] ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
- [ ] æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- [ ] æœç´¢ç”¨æˆ·
- [ ] è¿‡æ»¤è§’è‰²
- [ ] æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
- [ ] åˆ›å»ºæ–°ç”¨æˆ·
  - [ ] ç”¨æˆ·åéªŒè¯
  - [ ] é‚®ç®±éªŒè¯
  - [ ] å¯†ç å¼ºåº¦éªŒè¯
- [ ] ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
- [ ] æ›´æ”¹ç”¨æˆ·è§’è‰²
- [ ] é‡ç½®ç”¨æˆ·å¯†ç 
- [ ] åˆ é™¤å•ä¸ªç”¨æˆ·
- [ ] æ‰¹é‡åˆ é™¤ç”¨æˆ·
- [ ] æƒé™éªŒè¯ï¼ˆéç®¡ç†å‘˜æ— æ³•è®¿é—®ï¼‰

---

## 9. éƒ¨ç½²æŒ‡å—

### 9.1 æ•°æ®åº“è¿ç§»

```bash
cd backend
source venv/bin/activate
python3 update_user_table.py
```

### 9.2 åˆ›å»ºåˆå§‹ç®¡ç†å‘˜

**è„šæœ¬**: `backend/create_admin.py`

```python
#!/usr/bin/env python3
"""åˆ›å»ºåˆå§‹ç®¡ç†å‘˜è´¦æˆ·"""
import asyncio
from app.models.user import User
from app.core.security import hash_password
from tortoise import Tortoise

async def create_admin():
    await Tortoise.init(
        db_url='sqlite://./systemx.db',
        modules={'models': ['app.models.user']}
    )

    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç®¡ç†å‘˜
    admin = await User.get_or_none(username="admin")
    if admin:
        print("âŒ ç®¡ç†å‘˜è´¦æˆ·å·²å­˜åœ¨")
        await Tortoise.close_connections()
        return

    # åˆ›å»ºç®¡ç†å‘˜
    admin = await User.create(
        username="admin",
        email="admin@systemx.com",
        password_hash=hash_password("Admin@123"),
        role="admin",
        is_active=True
    )

    print(f"âœ… ç®¡ç†å‘˜è´¦æˆ·åˆ›å»ºæˆåŠŸ")
    print(f"   ç”¨æˆ·å: admin")
    print(f"   å¯†ç : Admin@123")
    print(f"   âš ï¸  è¯·ç«‹å³ç™»å½•å¹¶ä¿®æ”¹å¯†ç ï¼")

    await Tortoise.close_connections()

if __name__ == "__main__":
    asyncio.run(create_admin())
```

**æ‰§è¡Œ**:
```bash
python3 backend/create_admin.py
```

### 9.3 å¯åŠ¨æœåŠ¡

```bash
# åç«¯
cd backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# å‰ç«¯
cd frontend
npm run dev
```

### 9.4 è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½

1. è®¿é—® http://localhost:5173
2. ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•ï¼ˆadmin / Admin@123ï¼‰
3. å¯¼èˆªåˆ°ç”¨æˆ·ç®¡ç†é¡µé¢
4. å¼€å§‹ç®¡ç†ç”¨æˆ·

---

## ğŸ¯ æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°ï¼ŒåŒ…æ‹¬ï¼š

### âœ… åŠŸèƒ½å®Œæ•´æ€§
- ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢ï¼ˆåˆ†é¡µã€æœç´¢ã€è¿‡æ»¤ï¼‰
- ç”¨æˆ·è¯¦æƒ…æŸ¥çœ‹
- ç”¨æˆ·åˆ›å»º
- ç”¨æˆ·ä¿¡æ¯ç¼–è¾‘
- å¯†ç é‡ç½®
- ç”¨æˆ·åˆ é™¤ï¼ˆå•ä¸ª/æ‰¹é‡ï¼‰

### âœ… å®‰å…¨æ€§
- JWT è®¤è¯
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- å¯†ç å¼ºåº¦éªŒè¯
- SQL æ³¨å…¥é˜²æŠ¤
- CORS é…ç½®

### âœ… ç”¨æˆ·ä½“éªŒ
- ç›´è§‚çš„ç•Œé¢è®¾è®¡
- å‹å¥½çš„é”™è¯¯æç¤º
- å®æ—¶è¡¨å•éªŒè¯
- åˆ†é¡µå’Œæœç´¢åŠŸèƒ½

### âœ… å¯ç»´æŠ¤æ€§
- æ¸…æ™°çš„ä»£ç ç»“æ„
- å®Œæ•´çš„æ–‡æ¡£è¯´æ˜
- æ ‡å‡†çš„ RESTful API
- å¯æ‰©å±•çš„æ¶æ„è®¾è®¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-02
**ä½œè€…**: Claude Code
