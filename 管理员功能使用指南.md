# ç®¡ç†å‘˜åŠŸèƒ½ä½¿ç”¨æŒ‡å—

> **çŠ¶æ€**: âœ… åç«¯ API å·²å®Œæˆå¹¶å¯ç”¨
> **æ—¥æœŸ**: 2025-11-02

## ğŸ“‹ æ¦‚è¿°

ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†åŠŸèƒ½å·²å®Œæˆåç«¯å®ç°ï¼Œæ”¯æŒå®Œæ•´çš„ CRUD æ“ä½œã€‚å‰ç«¯ UI ç»„ä»¶å¯æ ¹æ®éœ€è¦æ·»åŠ ã€‚

## ğŸ”‘ ç®¡ç†å‘˜è´¦æˆ·

å½“å‰ç³»ç»Ÿå·²é…ç½®ç®¡ç†å‘˜è´¦æˆ·ï¼š

```
ç”¨æˆ·å: rachel
é‚®ç®±: Rachel_ruoqi@outlook.com
è§’è‰²: admin
```

ä½¿ç”¨è¯¥è´¦æˆ·ç™»å½•åå¯ä»¥è®¿é—®ç®¡ç†å‘˜ APIã€‚

## ğŸ› ï¸ åç«¯ API ç«¯ç‚¹

### 1. è·å–ç”¨æˆ·åˆ—è¡¨

```bash
GET /api/v1/admin/users?page=1&limit=20&search=rachel&role=admin
```

**æŸ¥è¯¢å‚æ•°**:
- `page`: é¡µç ï¼ˆé»˜è®¤ 1ï¼‰
- `limit`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 20ï¼Œæœ€å¤§ 100ï¼‰
- `search`: æœç´¢å…³é”®è¯ï¼ˆåŒ¹é…ç”¨æˆ·åæˆ–é‚®ç®±ï¼‰
- `role`: è§’è‰²è¿‡æ»¤ï¼ˆ"user" æˆ– "admin"ï¼‰
- `sort_by`: æ’åºå­—æ®µï¼ˆé»˜è®¤ "created_at"ï¼‰
- `sort_order`: æ’åºæ–¹å‘ï¼ˆ"asc" æˆ– "desc"ï¼Œé»˜è®¤ "desc"ï¼‰

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "username": "rachel",
        "email": "Rachel_ruoqi@outlook.com",
        "role": "admin",
        "is_active": true,
        "created_at": "2025-11-02T10:30:00Z",
        "last_login": "2025-11-02T18:45:00Z"
      }
    ],
    "pagination": {
      "total": 1,
      "page": 1,
      "pageSize": 20,
      "totalPages": 1
    }
  }
}
```

### 2. è·å–ç”¨æˆ·è¯¦æƒ…

```bash
GET /api/v1/admin/users/{user_id}
```

### 3. åˆ›å»ºç”¨æˆ·

```bash
POST /api/v1/admin/users
Content-Type: application/json

{
  "username": "newuser",
  "email": "newuser@example.com",
  "password": "SecurePass123",
  "role": "user"
}
```

**å¯†ç è¦æ±‚**:
- è‡³å°‘ 8 ä¸ªå­—ç¬¦
- å¿…é¡»åŒ…å«å°å†™å­—æ¯
- å¿…é¡»åŒ…å«å¤§å†™å­—æ¯
- å¿…é¡»åŒ…å«æ•°å­—

### 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯

```bash
PUT /api/v1/admin/users/{user_id}
Content-Type: application/json

{
  "username": "updated_username",
  "email": "new@email.com",
  "role": "admin",
  "is_active": true
}
```

**æ³¨æ„**:
- æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¯é€‰çš„
- ä¸èƒ½ç§»é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜çš„ç®¡ç†å‘˜æƒé™

### 5. é‡ç½®ç”¨æˆ·å¯†ç 

```bash
POST /api/v1/admin/users/{user_id}/reset-password
Content-Type: application/json

{
  "new_password": "NewSecurePass456"
}
```

### 6. åˆ é™¤ç”¨æˆ·

```bash
DELETE /api/v1/admin/users/{user_id}?cascade=true
```

**ä¿æŠ¤æœºåˆ¶**:
- âŒ ä¸èƒ½åˆ é™¤è‡ªå·±
- âŒ ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜
- âœ… `cascade=true` æ—¶ä¼šçº§è”åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯å’Œå¯¹è¯è®°å½•

### 7. æ‰¹é‡åˆ é™¤ç”¨æˆ·

```bash
POST /api/v1/admin/users/batch-delete
Content-Type: application/json

{
  "user_ids": ["uuid1", "uuid2"],
  "cascade": true
}
```

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. ç™»å½•è·å–ç®¡ç†å‘˜æƒé™

```bash
# ç™»å½•å¹¶ä¿å­˜ cookie
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"rachel","password":"Test123"}' \
  -c cookies.txt

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "data": {
    "user": {
      "id": "...",
      "username": "rachel",
      "email": "Rachel_ruoqi@outlook.com",
      "role": "admin"
    },
    "accessToken": "eyJ..."
  }
}
```

### 2. æµ‹è¯•è·å–ç”¨æˆ·åˆ—è¡¨

```bash
curl -X GET "http://localhost:8000/api/v1/admin/users?page=1&limit=10" \
  -b cookies.txt
```

### 3. æµ‹è¯•åˆ›å»ºç”¨æˆ·

```bash
curl -X POST http://localhost:8000/api/v1/admin/users \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "TestPass123",
    "role": "user"
  }'
```

### 4. æµ‹è¯•æ›´æ–°ç”¨æˆ·è§’è‰²

```bash
# å…ˆè·å–ç”¨æˆ·åˆ—è¡¨æ‰¾åˆ°ç”¨æˆ·ID
USER_ID="..." # ä»ä¸Šä¸€æ­¥å“åº”ä¸­è·å–

curl -X PUT http://localhost:8000/api/v1/admin/users/$USER_ID \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"role": "admin"}'
```

### 5. æµ‹è¯•åˆ é™¤ç”¨æˆ·

```bash
curl -X DELETE http://localhost:8000/api/v1/admin/users/$USER_ID?cascade=true \
  -b cookies.txt
```

## ğŸ”’ æƒé™æ§åˆ¶

æ‰€æœ‰ç®¡ç†å‘˜ API éƒ½é€šè¿‡ `require_admin` ä¾èµ–è¿›è¡Œä¿æŠ¤ï¼š

1. **èº«ä»½éªŒè¯**: æ£€æŸ¥ JWT tokenï¼ˆä» Cookie æˆ– Authorization headerï¼‰
2. **è§’è‰²éªŒè¯**: ç¡®è®¤ç”¨æˆ·è§’è‰²ä¸º "admin"
3. **å¤±è´¥å“åº”**:
   ```json
   {
     "detail": "éœ€è¦ç®¡ç†å‘˜æƒé™"
   }
   ```

## ğŸ“¦ æ•°æ®åº“å­—æ®µ

ç”¨æˆ·è¡¨å·²æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|--------|
| `is_active` | BOOLEAN | è´¦æˆ·çŠ¶æ€ | TRUE |
| `updated_at` | TIMESTAMP | æœ€åæ›´æ–°æ—¶é—´ | CURRENT_TIMESTAMP |
| `last_login` | TIMESTAMP | æœ€åç™»å½•æ—¶é—´ | NULL |

## ğŸ¯ å‰ç«¯é›†æˆ

å‰ç«¯ API å®¢æˆ·ç«¯å·²åˆ›å»ºï¼š`frontend/src/api/admin.js`

**å¯ç”¨å‡½æ•°**:
```javascript
import {
  getUserList,
  getUserDetail,
  createUser,
  updateUser,
  resetUserPassword,
  deleteUser,
  batchDeleteUsers
} from '@/api/admin';

// ç¤ºä¾‹ï¼šè·å–ç”¨æˆ·åˆ—è¡¨
const result = await getUserList({ page: 1, limit: 20, search: 'rachel' });
if (result.ok) {
  console.log(result.data.users);
  console.log(result.data.pagination);
}

// ç¤ºä¾‹ï¼šåˆ›å»ºç”¨æˆ·
const createResult = await createUser({
  username: 'newuser',
  email: 'new@example.com',
  password: 'SecurePass123',
  role: 'user'
});
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **å¯†ç å®‰å…¨**: æ‰€æœ‰å¯†ç ä½¿ç”¨ Argon2 å“ˆå¸Œç®—æ³•åŠ å¯†
2. **å”¯ä¸€æ€§çº¦æŸ**: ç”¨æˆ·åå’Œé‚®ç®±å¿…é¡»å”¯ä¸€
3. **çº§è”åˆ é™¤**: åˆ é™¤ç”¨æˆ·æ—¶å¯é€‰æ‹©æ˜¯å¦åˆ é™¤å…³è”çš„ä¼šè¯å’Œå¯¹è¯
4. **ç®¡ç†å‘˜ä¿æŠ¤**: ç³»ç»Ÿå§‹ç»ˆä¿ç•™è‡³å°‘ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·
5. **Cookie è®¤è¯**: API ä½¿ç”¨ HttpOnly Cookie å­˜å‚¨ JWT token

## ğŸš€ ä¸‹ä¸€æ­¥

å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ ï¼š
1. React å‰ç«¯ç”¨æˆ·ç®¡ç†ç•Œé¢
2. ç”¨æˆ·æ´»åŠ¨æ—¥å¿—è®°å½•
3. æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
4. ç”¨æˆ·å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-11-02
